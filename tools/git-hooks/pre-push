#!/bin/bash
set -euo pipefail

echo "ğŸš€ Running pre-push checks..."

#######################################
# Disable Go coverage redesign explicitly
#######################################
export GODEBUG=coverageredesign=0
unset GOEXPERIMENT

#######################################
# 1. Full lint
#######################################
echo "ğŸ” Running golangci-lint..."
golangci-lint run

#######################################
# 2. Unit tests with coverage (classic mode)
#######################################
echo "ğŸ§ª Running unit tests with coverage..."
go test ./... -coverprofile=coverage.out

#######################################
# 3. Enforce minimum coverage
#######################################
MIN_COVERAGE=80

TOTAL_COVERAGE=$(go tool cover -func=coverage.out \
  | awk '/^total:/ { sub(/%/, "", $3); print int($3) }')

echo "ğŸ“Š Total test coverage: ${TOTAL_COVERAGE}%"

if [ "$TOTAL_COVERAGE" -lt "$MIN_COVERAGE" ]; then
    echo "âŒ Coverage threshold not met (required: ${MIN_COVERAGE}%)"
    exit 1
fi

#######################################
# 4. Build validation
#######################################
echo "ğŸ—ï¸ Building application..."
go build ./cmd/app

#######################################
# Cleanup
#######################################
rm -f coverage.out

echo "âœ… Pre-push checks passed!"
